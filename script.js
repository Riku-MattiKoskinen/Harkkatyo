// script.js
document.addEventListener('DOMContentLoaded', function() {
    var map = L.map('map', {
        minZoom: -3
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const apiUrl = 'https://statfin.stat.fi:443/PxWeb/api/v1/fi/StatFin/evaa/statfin_evaa_pxt_13sw.px';
    const queryObj = {
            "query": [
              {
                "code": "Vuosi",
                "selection": {
                  "filter": "item",
                  "values": [
                    "2023"
                  ]
                }
              },
              {
                "code": "Sukupuoli",
                "selection": {
                  "filter": "item",
                  "values": [
                    "SSS"
                  ]
                }
              },
              {
                "code": "Puolue",
                "selection": {
                  "filter": "item",
                  "values": [
                    "SSS",
                    "03",
                    "02",
                    "01",
                    "04",
                    "05",
                    "06",
                    "07",
                    "08",
                    "09",
                    "20",
                    "10",
                    "11",
                    "12",
                    "14",
                    "15",
                    "16",
                    "17",
                    "19",
                    "21",
                    "22",
                    "23",
                    "24",
                    "44",
                    "35",
                    "36",
                    "37",
                    "38",
                    "39",
                    "40",
                    "41",
                    "42",
                    "46",
                    "47",
                    "48",
                    "49",
                    "50",
                    "51",
                    "55",
                    "66",
                    "77",
                    "99"
                  ]
                }
              },
              {
                "code": "Vaalipiiri ja kunta vaalivuonna",
                "selection": {
                  "filter": "item",
                  "values": [
                    "SSS",
                    "010091",
                    "020018",
                    "020049",
                    "020078",
                    "020092",
                    "020106",
                    "020149",
                    "020186",
                    "020224",
                    "020235",
                    "020245",
                    "020257",
                    "020407",
                    "020434",
                    "020424",
                    "020585",
                    "020701",
                    "020444",
                    "020427",
                    "020428",
                    "020737",
                    "020223",
                    "020540",
                    "020504",
                    "020505",
                    "020543",
                    "020611",
                    "020616",
                    "020638",
                    "020612",
                    "020613",
                    "020710",
                    "020220",
                    "020606",
                    "020835",
                    "020842",
                    "020753",
                    "020755",
                    "020858",
                    "020927",
                    "030019",
                    "030202",
                    "030602",
                    "030284",
                    "030304",
                    "030322",
                    "030040",
                    "030243",
                    "030923",
                    "030400",
                    "030423",
                    "030838",
                    "030430",
                    "030431",
                    "030006",
                    "030482",
                    "030445",
                    "030101",
                    "030150",
                    "030279",
                    "030533",
                    "030573",
                    "030480",
                    "030481",
                    "030017",
                    "030419",
                    "030503",
                    "030490",
                    "030529",
                    "030485",
                    "030705",
                    "030920",
                    "030538",
                    "030561",
                    "030577",
                    "030631",
                    "030636",
                    "030219",
                    "030979",
                    "030680",
                    "030704",
                    "030906",
                    "030734",
                    "030073",
                    "030252",
                    "030259",
                    "030308",
                    "030501",
                    "030586",
                    "030587",
                    "030776",
                    "030784",
                    "030738",
                    "030761",
                    "030833",
                    "030853",
                    "030895",
                    "030209",
                    "030918",
                    "040050",
                    "040262",
                    "040051",
                    "040442",
                    "040079",
                    "040102",
                    "040913",
                    "040181",
                    "040214",
                    "040099",
                    "040230",
                    "040271",
                    "040484",
                    "040531",
                    "040608",
                    "040609",
                    "040537",
                    "040413",
                    "040684",
                    "040685",
                    "040266",
                    "040406",
                    "040747",
                    "040783",
                    "040319",
                    "040886",
                    "040293",
                    "060016",
                    "060061",
                    "060081",
                    "060082",
                    "060086",
                    "060098",
                    "060283",
                    "060103",
                    "060109",
                    "060083",
                    "060210",
                    "060401",
                    "060692",
                    "060855",
                    "060111",
                    "060088",
                    "060089",
                    "060142",
                    "060165",
                    "060169",
                    "060316",
                    "060398",
                    "060532",
                    "060433",
                    "060560",
                    "060015",
                    "060576",
                    "060694",
                    "060781",
                    "060834",
                    "060981",
                    "070020",
                    "070864",
                    "070928",
                    "070310",
                    "070108",
                    "070143",
                    "070177",
                    "070211",
                    "070730",
                    "070289",
                    "070250",
                    "070291",
                    "070418",
                    "070508",
                    "070506",
                    "070933",
                    "070536",
                    "070562",
                    "070581",
                    "070604",
                    "070619",
                    "070635",
                    "070439",
                    "070702",
                    "070790",
                    "070493",
                    "070912",
                    "070772",
                    "070988",
                    "070254",
                    "070837",
                    "070887",
                    "070908",
                    "070922",
                    "070936",
                    "070980",
                    "070932",
                    "070303",
                    "080046",
                    "080075",
                    "080917",
                    "080097",
                    "080153",
                    "080178",
                    "080213",
                    "080285",
                    "080286",
                    "080044",
                    "080163",
                    "080306",
                    "080754",
                    "080909",
                    "080405",
                    "080539",
                    "080173",
                    "080978",
                    "080416",
                    "080441",
                    "080489",
                    "080491",
                    "080014",
                    "080492",
                    "080085",
                    "080696",
                    "080775",
                    "080507",
                    "080580",
                    "080728",
                    "080891",
                    "080588",
                    "080593",
                    "080184",
                    "080594",
                    "080937",
                    "080623",
                    "080624",
                    "080681",
                    "080689",
                    "080700",
                    "080739",
                    "080740",
                    "080741",
                    "080246",
                    "080618",
                    "080768",
                    "080831",
                    "080935",
                    "090090",
                    "090140",
                    "090146",
                    "090167",
                    "090251",
                    "090856",
                    "090045",
                    "090632",
                    "090171",
                    "090176",
                    "090204",
                    "090239",
                    "090260",
                    "090248",
                    "090263",
                    "090276",
                    "090297",
                    "090919",
                    "090227",
                    "090534",
                    "090476",
                    "090174",
                    "090309",
                    "090402",
                    "090916",
                    "090420",
                    "090422",
                    "090426",
                    "090541",
                    "090911",
                    "090595",
                    "090607",
                    "090686",
                    "090687",
                    "090707",
                    "090749",
                    "090762",
                    "090778",
                    "090844",
                    "090848",
                    "090943",
                    "090857",
                    "090915",
                    "090212",
                    "090921",
                    "090925",
                    "100005",
                    "100414",
                    "100010",
                    "100863",
                    "100052",
                    "100074",
                    "100145",
                    "100151",
                    "100152",
                    "100217",
                    "100218",
                    "100231",
                    "100232",
                    "100233",
                    "100004",
                    "100281",
                    "100971",
                    "100236",
                    "100272",
                    "100315",
                    "100429",
                    "100885",
                    "100280",
                    "100287",
                    "100288",
                    "100300",
                    "100301",
                    "100175",
                    "100164",
                    "100399",
                    "100403",
                    "100408",
                    "100421",
                    "100440",
                    "100475",
                    "100499",
                    "100545",
                    "100584",
                    "100598",
                    "100599",
                    "100743",
                    "100589",
                    "100544",
                    "100975",
                    "100759",
                    "100846",
                    "100849",
                    "100893",
                    "100905",
                    "100942",
                    "100924",
                    "100934",
                    "100946",
                    "100559",
                    "100945",
                    "100479",
                    "100944",
                    "100989",
                    "110077",
                    "110172",
                    "110415",
                    "110179",
                    "110787",
                    "110180",
                    "110277",
                    "110182",
                    "110299",
                    "110443",
                    "110183",
                    "110216",
                    "110226",
                    "110249",
                    "110256",
                    "110265",
                    "110275",
                    "110312",
                    "110410",
                    "110435",
                    "110495",
                    "110500",
                    "110592",
                    "110601",
                    "110729",
                    "110633",
                    "110850",
                    "110892",
                    "110931",
                    "110992",
                    "110274",
                    "110770",
                    "110774",
                    "120009",
                    "120069",
                    "120071",
                    "120072",
                    "120105",
                    "120139",
                    "120292",
                    "120205",
                    "120940",
                    "120208",
                    "120095",
                    "120244",
                    "120290",
                    "120305",
                    "120317",
                    "120425",
                    "120436",
                    "120483",
                    "120494",
                    "120535",
                    "120563",
                    "120564",
                    "120973",
                    "120084",
                    "120255",
                    "120567",
                    "120972",
                    "120578",
                    "120615",
                    "120620",
                    "120625",
                    "120626",
                    "120630",
                    "120678",
                    "120582",
                    "120926",
                    "120691",
                    "120697",
                    "120746",
                    "120748",
                    "120708",
                    "120765",
                    "120777",
                    "120785",
                    "120791",
                    "120247",
                    "120603",
                    "120617",
                    "120682",
                    "120832",
                    "120859",
                    "120841",
                    "120889",
                    "120977",
                    "130047",
                    "130148",
                    "130240",
                    "130241",
                    "130261",
                    "130273",
                    "130320",
                    "130498",
                    "130583",
                    "130614",
                    "130683",
                    "130698",
                    "130699",
                    "130732",
                    "130742",
                    "130751",
                    "130758",
                    "130845",
                    "130851",
                    "130854",
                    "130890",
                    "130976",
                    "050035",
                    "050043",
                    "050060",
                    "050062",
                    "050065",
                    "050076",
                    "050170",
                    "050295",
                    "050318",
                    "050417",
                    "050438",
                    "050478",
                    "050736",
                    "050766",
                    "050771",
                    "050941"
                  ]
                }
              },
              {
                "code": "Tiedot",
                "selection": {
                  "filter": "item",
                  "values": [
                    "evaa_aanet"
                  ]
                }
              }
            ],
            "response": {
              "format": "json"
            }

          
    };

    const votesByMunicipality = {};

    fetch(apiUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(queryObj)
    })
    .then(response => response.json())
    .then(data => {
        // Convert your data into votesByMunicipality object
    })
    .catch(error => {
        console.error('Error:', error);
    });

    const onEachFeature = (feature, layer) => {
        if (feature.properties && feature.properties.name) {
            layer.bindTooltip(feature.properties.name, { permanent: false });
            layer.on('click', function(e) {
                const municipality = feature.properties.name;
                const votes = votesByMunicipality[municipality];
                if (votes) {
                    alert(`Votes in ${municipality}: ${votes}`);
                }
            });
        }
    };

    fetch('https://geo.stat.fi/geoserver/wfs?service=WFS&version=2.0.0&request=GetFeature&typeName=tilastointialueet:kunta4500k&outputFormat=json&srsName=EPSG:4326')
    .then(response => response.json())
    .then(data => {
        const geojsonLayer = L.geoJSON(data, {
            weight: 2,
            onEachFeature: onEachFeature
        }).addTo(map);
        map.fitBounds(geojsonLayer.getBounds());
    })
    .catch(error => console.error('Error fetching GeoJSON data:', error));
});
